openapi: 3.0.0
info:
  version: v1.0
  title: Consent Purpose Management API
  description: |
    This API provides endpoints for managing consent purposes. Consent purposes are used to categorize and define 
    the intended use of consents (e.g., "Account Information Access", "Payment Initiation", "Marketing", etc.).
    
    Purposes can be created, retrieved, updated, and deleted. They serve as reference data that can be optionally 
    linked to consents to provide clear categorization of consent usage.
  contact:
    name: WSO2
    url: 'https://wso2.com/solutions/financial-services/'
    email: "architecture@wso2.com"
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
servers:
  - url: https://{host}:{port}/api/v1
    variables:
      host:
        default: localhost
        description: Hostname of the Consent Management server.
      port:
        default: "8080"
        description: Port number for the Consent Management server.
tags:
  - name: Consent Purpose
    description: Manage consent purposes (reference data for categorizing consents)
paths:
  /consent-purposes:
    post:
      summary: Create one or more consent purposes
      description: |
        Creates one or more consent purposes in a single request. Supports batch creation by accepting 
        an array of purpose definitions.
        
        Each purpose must have a unique name within the organization. The description field is optional 
        and can be used to provide additional context about the purpose.
        
        **Transactional Behavior:**
        Batch creation is atomic - either all purposes in the request are created successfully, or none 
        are created. If any validation fails (e.g., duplicate name, invalid type, missing required field), 
        the entire batch is rolled back and no purposes are persisted to the database. This ensures data 
        consistency and prevents partial batch insertions.
        
        **Validation Rules:**
        - Name is required and must not exceed 255 characters
        - Name must be unique within the organization (checked against existing purposes and within the batch)
        - Type is required and must be one of: `string`, `json-schema`
        - Value is required and can be a string, JSON object, or JSON array
        - Description is optional but must not exceed 1024 characters if provided
        - At least one purpose must be provided in the request array
        - Duplicate names within the same batch are not allowed
        
        **Uniqueness Constraint:**
        If a purpose with the same name already exists for the organization (or appears multiple times 
        in the batch), the entire request will be rejected with a 400 Bad Request error and no purposes 
        will be created.
      operationId: createConsentPurposes
      tags:
        - Consent Purpose
      parameters:
        - in: header
          name: org-id
          required: true
          description: The unique identifier for the organization that owns these purposes
          schema:
            type: string
            example: "ORG-123"
        - in: header
          name: client-id
          required: false
          description: The client ID of the application making the request (for audit purposes)
          schema:
            type: string
            example: "CLIENT-456"
      requestBody:
        description: Array of consent purposes to create
        required: true
        content:
          application/json:
            schema:
              type: array
              minItems: 1
              items:
                $ref: "#/components/schemas/ConsentPurposeCreateRequest"
            examples:
              single:
                summary: Create a single purpose with string value
                value:
                  - name: "license_read"
                    description: "Allows accessing license API"
                    type: "string"
                    value: "license:read"
              multiple:
                summary: Create multiple purposes with string values
                value:
                  - name: "license_read"
                    description: "Allows accessing license API"
                    type: "string"
                    value: "license:read"
                  - name: "tax_read"
                    description: "Allows accessing tax API"
                    type: "string"
                    value: "tax:read"
                  - name: "utility_read"
                    description: "Allows accessing utility API"
                    type: "string"
                    value: "utility:read"
              jsonObject:
                summary: Create purpose with JSON object value
                value:
                  - name: "account_schema"
                    description: "Account access schema with permissions"
                    type: "json-schema"
                    value:
                      permissions:
                        - "read"
                        - "write"
                      scopes:
                        - "account.basic"
                        - "account.transactions"
                      metadata:
                        version: "1.0"
                        required: true
              jsonArray:
                summary: Create purpose with JSON array value
                value:
                  - name: "allowed_operations"
                    description: "List of allowed operations"
                    type: "string"
                    value:
                      - "create"
                      - "read"
                      - "update"
                      - "delete"
      responses:
        "201":
          description: Successfully created consent purpose(s)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/ConsentPurposeResponse"
                  message:
                    type: string
                    example: "Consent purposes created successfully"
              examples:
                single:
                  summary: Single purpose created
                  value:
                    data:
                      - id: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                        name: "readAccountBasic"
                        description: "Allows reading basic account information."
                        type: "string"
                        value: "account:read:basic"
                    message: "Consent purposes created successfully"
                multiple:
                  summary: Multiple purposes created
                  value:
                    data:
                      - id: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                        name: "license_read"
                        description: "Allows accessing license API"
                        type: "string"
                        value: "license:read"
                      - id: "PURPOSE-b2c3d4e5-f6a7-8901-bcde-f12345678901"
                        name: "tax_read"
                        description: "Allows accessing tax API"
                        type: "string"
                        value: "tax:read"
                      - id: "PURPOSE-c3d4e5f6-a7b8-9012-cdef-123456789012"
                        name: "utility_read"
                        description: "Allows accessing utility API"
                        type: "string"
                        value: "utility:read"
                    message: "Consent purposes created successfully"
                jsonObject:
                  summary: Purpose created with JSON object value
                  value:
                    data:
                      - id: "PURPOSE-d4e5f6a7-b8c9-0123-def4-56789abcdef0"
                        name: "account_schema"
                        description: "Account access schema with permissions"
                        type: "json-schema"
                        value:
                          permissions:
                            - "read"
                            - "write"
                          scopes:
                            - "account.basic"
                            - "account.transactions"
                          metadata:
                            version: "1.0"
                            required: true
                    message: "Consent purposes created successfully"
                jsonArray:
                  summary: Purpose created with JSON array value
                  value:
                    data:
                      - id: "PURPOSE-e5f6a7b8-c9d0-1234-ef56-789abcdef012"
                        name: "allowed_operations"
                        description: "List of allowed operations"
                        type: "string"
                        value:
                          - "create"
                          - "read"
                          - "update"
                          - "delete"
                    message: "Consent purposes created successfully"
        "400":
          description: Bad Request - Invalid input or validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                emptyArray:
                  summary: Empty array provided
                  value:
                    code: "BAD_REQUEST"
                    message: "Empty request"
                    details: "At least one purpose must be provided"
                missingName:
                  summary: Missing required name field
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request body"
                    details: "Key: 'ConsentPurposeCreateRequest.Name' Error:Field validation for 'Name' failed on the 'required' tag"
                missingType:
                  summary: Missing required type field
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request body"
                    details: "Key: 'ConsentPurposeCreateRequest.Type' Error:Field validation for 'Type' failed on the 'required' tag"
                missingValue:
                  summary: Missing required value field
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request body"
                    details: "Key: 'ConsentPurposeCreateRequest.Value' Error:Field validation for 'Value' failed on the 'required' tag"
                invalidType:
                  summary: Invalid type value
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request body"
                    details: "invalid purpose type: invalid purpose type 'invalid-type': must be one of [string, json-schema]"
                nameTooLong:
                  summary: Name exceeds maximum length
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request"
                    details: "purpose name too long: maximum 255 characters"
                duplicateName:
                  summary: Purpose name already exists
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request"
                    details: "purpose name 'readAccountBasic' already exists for this organization"
                duplicateInBatch:
                  summary: Duplicate names within the same batch
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request"
                    details: "duplicate purpose name 'readAccountBasic' found at index 0 and 2 in the batch"
                transactionRollback:
                  summary: Batch rolled back due to validation failure
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request"
                    details: "purpose name 'existingPurpose' already exists for this organization (at index 2)"
                    error: "Transaction rolled back - no purposes were created"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      security:
        - basicAuth: []
    get:
      summary: List all consent purposes
      description: |
        Retrieves a paginated list of all consent purposes for the specified organization.
        
        Results are ordered alphabetically by purpose name by default. Use the `limit` and `offset` 
        query parameters to control pagination.
      operationId: listConsentPurposes
      tags:
        - Consent Purpose
      parameters:
        - in: header
          name: org-id
          required: true
          description: The unique identifier for the organization
          schema:
            type: string
            example: "ORG-123"
        - name: limit
          in: query
          description: Maximum number of purposes to return (default 100, max 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 100
            example: 10
        - name: offset
          in: query
          description: Number of purposes to skip for pagination (default 0)
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        "200":
          description: Successfully retrieved consent purposes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsentPurposeListResponse"
              example:
                purposes:
                  - id: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                    name: "Marketing"
                    description: "Purpose for marketing and promotional communications"
                    type: "string"
                    value: "marketing:communications"
                  - id: "PURPOSE-b2c3d4e5-f6a7-8901-bcde-f12345678901"
                    name: "readAccountBasic"
                    description: "Allows reading basic account information"
                    type: "string"
                    value: "account:read:basic"
                  - id: "PURPOSE-c3d4e5f6-a7b8-9012-cdef-123456789012"
                    name: "readTransactions"
                    description: "Allows reading transaction history"
                    type: "string"
                    value: "account:read:transactions"
                total: 3
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      security:
        - basicAuth: []
  /consent-purposes/validate:
    post:
      summary: Validate consent purpose names
      description: |
        Validates a list of consent purpose names and returns only the valid ones that exist in the database.
        
        This endpoint is useful for:
        - Validating purpose names before creating consents
        - Filtering out invalid purposes from a list
        - Checking which purposes are available in the organization
        
        **Behavior:**
        - Accepts an array of purpose names
        - Returns an array of names that exist in the organization
        - If none of the provided names are valid, returns 400 Bad Request
        - Names are case-sensitive and must match exactly
        - Empty request array returns 400 Bad Request
        
        **Response:**
        - **200 OK**: Returns array of valid purpose names (subset of input)
        - **400 Bad Request**: When request is empty or no valid purposes found
      operationId: validateConsentPurposes
      tags:
        - Consent Purpose
      parameters:
        - in: header
          name: org-id
          required: true
          description: The unique identifier for the organization
          schema:
            type: string
            example: "ORG-123"
      requestBody:
        description: Array of purpose names to validate
        required: true
        content:
          application/json:
            schema:
              type: array
              minItems: 1
              items:
                type: string
              example:
                - "utility_read"
                - "taxes_read"
                - "profile_read"
            examples:
              allValid:
                summary: All purposes are valid
                value:
                  - "utility_read"
                  - "taxes_read"
              partialValid:
                summary: Some valid, some invalid
                value:
                  - "utility_read"
                  - "invalid_purpose"
                  - "taxes_read"
      responses:
        "200":
          description: Successfully validated purposes (returns only valid ones)
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
              examples:
                allValid:
                  summary: All provided purposes were valid
                  value:
                    - "utility_read"
                    - "taxes_read"
                partialValid:
                  summary: Only valid purposes returned
                  value:
                    - "utility_read"
                    - "taxes_read"
        "400":
          description: Bad Request - Empty request or no valid purposes found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                emptyRequest:
                  summary: Empty request array
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request"
                    details: "at least one purpose name must be provided"
                noValidPurposes:
                  summary: No valid purposes found
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request"
                    details: "no valid purposes found"
                missingOrgId:
                  summary: Missing org-id header
                  value:
                    code: "BAD_REQUEST"
                    message: "Invalid request"
                    details: "org-id header is required"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      security:
        - basicAuth: []
  /consent-purposes/{purposeId}:
    get:
      summary: Get a specific consent purpose
      description: Retrieves the details of a specific consent purpose by its ID
      operationId: getConsentPurpose
      tags:
        - Consent Purpose
      parameters:
        - in: header
          name: org-id
          required: true
          description: The unique identifier for the organization
          schema:
            type: string
            example: "ORG-123"
        - name: purposeId
          in: path
          required: true
          description: The unique identifier of the consent purpose
          schema:
            type: string
            example: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      responses:
        "200":
          description: Successfully retrieved consent purpose
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsentPurposeResponse"
              example:
                id: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                name: "readAccountBasic"
                description: "Allows reading basic account information"
                type: "string"
                value: "account:read:basic"
        "404":
          description: Consent purpose not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: "NOT_FOUND"
                message: "Consent purpose not found"
                details: ""
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      security:
        - basicAuth: []
    put:
      summary: Update a consent purpose
      description: |
        Updates an existing consent purpose. **All fields are required** - partial updates are not supported.
        
        **Validation Rules:**
        - name: Required, must not exceed 255 characters, must be unique within the organization
        - description: Optional, must not exceed 1024 characters if provided
        - type: Required, must be either 'string' or 'json-schema'
        - value: Required, can be a string, object, or array (any valid JSON value)
        
        **Uniqueness Constraint:**
        If changing the name to a value that already exists for another purpose in the organization, 
        the request will be rejected with a 400 Bad Request error.
      operationId: updateConsentPurpose
      tags:
        - Consent Purpose
      parameters:
        - in: header
          name: org-id
          required: true
          description: The unique identifier for the organization
          schema:
            type: string
            example: "ORG-123"
        - name: purposeId
          in: path
          required: true
          description: The unique identifier of the consent purpose to update
          schema:
            type: string
            example: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      requestBody:
        description: Complete purpose data (all fields required - no partial updates)
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConsentPurposeUpdateRequest"
            examples:
              updateStringValue:
                summary: Update with string value
                value:
                  name: "readAccountDetailedV2"
                  description: "Updated description with more details"
                  type: "string"
                  value: "account:read:detailed:v2"
              updateWithoutDescription:
                summary: Update without description (description is optional)
                value:
                  name: "readAccountBasic"
                  type: "string"
                  value: "account:read:basic"
              updateJSONObjectValue:
                summary: Update with JSON object value
                value:
                  name: "accountAccessSchema"
                  description: "Account access schema with permissions"
                  type: "json-schema"
                  value:
                    permissions:
                      - "read"
                      - "write"
                    scopes:
                      - "account.basic"
                      - "account.transactions"
              updateJSONArrayValue:
                summary: Update with JSON array value
                value:
                  name: "allowedOperations"
                  description: "List of allowed operations"
                  type: "string"
                  value:
                    - "create"
                    - "read"
                    - "update"
                    - "delete"
      responses:
        "200":
          description: Successfully updated consent purpose
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsentPurposeResponse"
              examples:
                updatedNameAndDescription:
                  summary: Updated name and description
                  value:
                    id: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                    name: "readAccountDetailedV2"
                    description: "Updated description with more details"
                    type: "string"
                    value: "account:read:basic"
                updatedValue:
                  summary: Updated type and value
                  value:
                    id: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                    name: "readAccountBasic"
                    description: "Allows reading basic account information"
                    type: "json-schema"
                    value:
                      permissions:
                        - "read"
                        - "write"
                      scopes:
                        - "account.basic"
                        - "account.transactions"
        "400":
          description: Bad Request - Invalid input or validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missingName:
                  summary: Missing required field (name)
                  value:
                    code: "INVALID_REQUEST"
                    message: "Invalid request"
                    details: "purpose name is required"
                missingType:
                  summary: Missing required field (type)
                  value:
                    code: "INVALID_REQUEST"
                    message: "Invalid request"
                    details: "purpose type is required"
                missingValue:
                  summary: Missing required field (value)
                  value:
                    code: "INVALID_REQUEST"
                    message: "Invalid request"
                    details: "purpose value is required"
                nameTooLong:
                  summary: Name exceeds maximum length
                  value:
                    code: "INVALID_REQUEST"
                    message: "Invalid request"
                    details: "purpose name too long: maximum 255 characters"
                duplicateName:
                  summary: Name already exists in organization
                  value:
                    code: "INVALID_REQUEST"
                    message: "Invalid request"
                    details: "purpose name 'readAccountBasic' already exists for this organization"
                invalidType:
                  summary: Invalid type value
                  value:
                    code: "INVALID_REQUEST"
                    message: "Invalid request"
                    details: "invalid purpose type: invalid purpose type 'invalid-type': must be one of [string, json-schema]"
        "404":
          description: Consent purpose not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      security:
        - basicAuth: []
    delete:
      summary: Delete a consent purpose
      description: |
        Deletes a consent purpose. The purpose must exist and belong to the specified organization.
        
        **Note:** This operation will not delete any mappings if the purpose is currently linked to consents. 
        The CASCADE DELETE in the database schema will handle cleanup of purpose-consent mappings automatically 
        when a consent is deleted.
      operationId: deleteConsentPurpose
      tags:
        - Consent Purpose
      parameters:
        - in: header
          name: org-id
          required: true
          description: The unique identifier for the organization
          schema:
            type: string
            example: "ORG-123"
        - name: purposeId
          in: path
          required: true
          description: The unique identifier of the consent purpose to delete
          schema:
            type: string
            example: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      responses:
        "204":
          description: Successfully deleted consent purpose (no content returned)
        "404":
          description: Consent purpose not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      security:
        - basicAuth: []

components:
  schemas:
    ConsentPurposeCreateRequest:
      type: object
      required:
        - name
        - type
        - value
      description: |
        Request object for creating a consent purpose. All fields marked as required must be provided.
        When creating multiple purposes in a batch:
        - Each purpose name must be unique within the batch
        - Each purpose name must not already exist in the organization
        - If any validation fails, the entire batch is rolled back (atomic operation)
      properties:
        name:
          type: string
          maxLength: 255
          description: |
            The name/identifier of the consent purpose. Must be unique within the organization.
            Database constraint: UNIQUE KEY unique_name_per_org (NAME, ORG_ID)
            Batch constraint: Must be unique within the batch request
          example: "license_read"
        description:
          type: string
          maxLength: 1024
          description: Optional description providing additional context about the purpose
          example: "Allows accessing license API"
        type:
          type: string
          enum:
            - string
            - json-schema
          description: |
            The type of the purpose value. Determines how the value should be interpreted.
            - 'string': Simple string value (e.g., permission name, scope)
            - 'json-schema': JSON schema definition for complex validation
          example: "string"
        value:
          description: |
            The actual value of the purpose. Format depends on the 'type' field:
            - If type='string': A simple string value like a permission or scope
            - If type='json-schema': A JSON schema object or any complex JSON structure
          oneOf:
            - type: string
            - type: object
            - type: array
          example: "license:read"
    
    ConsentPurposeUpdateRequest:
      type: object
      required:
        - name
        - type
        - value
      properties:
        name:
          type: string
          maxLength: 255
          description: Name for the consent purpose (required, must be unique within organization)
          example: "license_read_v2"
        description:
          type: string
          maxLength: 1024
          description: Description for the consent purpose (optional)
          example: "Updated description for license API access"
        type:
          type: string
          enum:
            - string
            - json-schema
          description: Type of the consent purpose value (required)
          example: "string"
        value:
          description: Value for the consent purpose (required, can be string, object, or array)
          oneOf:
            - type: string
            - type: object
            - type: array
          example: "license:read:v2"
      description: All fields except description are required - partial updates are not supported
    
    ConsentPurposeResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the consent purpose (UUID with PURPOSE- prefix)
          example: "PURPOSE-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        name:
          type: string
          description: The name/identifier of the consent purpose
          example: "license_read"
        description:
          type: string
          description: Description of the consent purpose
          example: "Allows accessing license API"
        type:
          type: string
          enum:
            - string
            - json-schema
          description: The type of the purpose value
          example: "string"
        value:
          description: The actual value of the purpose (can be string, object, or array based on type)
          oneOf:
            - type: string
            - type: object
            - type: array
          example: "license:read"
      required:
        - id
        - name
        - type
    
    ConsentPurposeListResponse:
      type: object
      properties:
        purposes:
          type: array
          description: Array of consent purposes
          items:
            $ref: "#/components/schemas/ConsentPurposeResponse"
        total:
          type: integer
          description: Total number of purposes available (for pagination)
          example: 25
      required:
        - purposes
        - total
    
    ErrorResponse:
      type: object
      properties:
        code:
          type: string
          description: Error code identifying the type of error
          enum:
            - BAD_REQUEST
            - UNAUTHORIZED
            - FORBIDDEN
            - NOT_FOUND
            - INTERNAL_SERVER_ERROR
          example: "BAD_REQUEST"
        message:
          type: string
          description: Human-readable error message
          example: "Invalid request body"
        details:
          type: string
          description: Additional details about the error
          example: "Key: 'ConsentPurposeCreateRequest.Name' Error:Field validation for 'Name' failed on the 'required' tag"
      required:
        - code
        - message

  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: HTTP Basic Authentication
